version: "3.9"

services:
  #################################################
  # MongoDB for Auth Service
  #################################################
  mongo-auth:
    image: mongo
    container_name: mongo-auth
    ports:
      - "27017:27017"
    volumes:
      - mongo-auth-data:/data/db

  #################################################
  # Auth Service
  #################################################
  auth-service:
    build: ./auth-service
    container_name: auth-service
    restart: always
    ports:
      - "8080:8080"
    environment:
      - MONGO_URI=mongodb://mongo-auth:27017
      - MONGO_DB=authdb
      - JWT_SECRET=${JWT_SECRET}
      - REFRESH_SECRET=${REFRESH_SECRET}
    depends_on:
      - mongo-auth

  #################################################
  # MongoDB for Driver Service
  #################################################
  mongo-driver:
    image: mongo
    container_name: mongo-driver
    ports:
      - "27018:27017"
    volumes:
      - mongo-driver-data:/data/db

  #################################################
  # Driver Service
  #################################################
  driver-service:
    build: ./driver-service
    container_name: driver-service
    restart: always
    ports:
      - "8090:8090"
    environment:
      - MONGO_URI=mongodb://mongo-driver:27017
      - MONGO_DB=driverdb
    depends_on:
      - mongo-driver

  #################################################
  # Redis for Location Service
  #################################################
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"

  #################################################
  # Location Service
  #################################################
  location-service:
    build: ./location-service
    container_name: location-service
    restart: always
    ports:
      - "8081:8081"
    environment:
      - APP_PORT=8081
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - NEARBY_RADIUS_KM=5
      - NEARBY_COUNT=20
    depends_on:
      - redis

  #################################################
  # Elasticsearch (Log storage)
  #################################################
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - esdata:/usr/share/elasticsearch/data

  #################################################
  # Kibana (Log dashboard)
  #################################################
  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

  #################################################
  # API Gateway
  #################################################
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    restart: always
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - AUTH_SERVICE_URL=http://auth-service:8080
      - DRIVER_SERVICE_URL=http://driver-service:8090
      - LOCATION_SERVICE_URL=http://location-service:8081
      - ELASTIC_URL=http://elasticsearch:9200
      - ELASTIC_INDEX=gateway-logs
    depends_on:
      - auth-service
      - driver-service
      - location-service
      - elasticsearch

volumes:
  mongo-auth-data:
  mongo-driver-data:
  esdata:
